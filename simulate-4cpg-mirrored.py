import os.path, sys
sys.path.append(os.path.join(os.path.dirname(os.path.realpath(__file__)), os.pardir))
from individual_factory import Individual, IndividualFactory
from robot import Robot
from cpgn import CPGN
import time

def run_simulation(individual):
    dt = 0.02
    dt_downsampled = 0.02
    presample_steps = 50000
    presample_threshold = 20000

    conn_config = [
        (0, 1),
        (1, 2),
        (2, 3)
    ]

    cpgns = []

    

    #print (t1, t2, w, b, u0, ue, uf, ve, vf)

    for i in range(4):
        t1 = float(individual.get(str(i)+'_t1'))
        t2 = float(individual.get(str(i)+'_t2'))
        w = float(individual.get(str(i)+'_w'))
        b = float(individual.get(str(i)+'_b'))
        u0 = float(individual.get(str(i)+'_u0'))

        # start values
        ue = float(individual.get(str(i)+'_ue'))
        uf = float(individual.get(str(i)+'_uf'))
        ve = float(individual.get(str(i)+'_ve'))
        vf = float(individual.get(str(i)+'_vf'))
        cpgns.append(CPGN("N" + str(i + 1), t1, t2, w, b, u0, ue, uf, ve, vf))

    for item in conn_config:
        cpgns[item[0]].connect(cpgns[item[1]], individual.get('w_' + str(item[0]) + '_' + str(item[1])))
        cpgns[item[1]].connect(cpgns[item[0]], individual.get('w_' + str(item[1]) + '_' + str(item[0])))

    # normalize
    cout_init = []
    for n in cpgns:
        cout_init.append([])

    for j in range(presample_steps+presample_threshold):
        for (i, n) in enumerate(cpgns):
            n.euler(dt)

        for (i, n) in enumerate(cpgns):
            n.step()
            #if(j % int(dt_downsampled/dt) == 0):
            if np.isnan(n.y) or n.y > 1000 or n.y < -1000:
                cout_init[i].append(0)
            else if j > presample_threshold:
                cout_init[i].append(n.y)

    normalize_factors = []

    for j in range(len(cout_init)):
        normalize_factors.appned(np.amax(cout_init[j]))

    for (i, n) in enumerate(cpgns):
        n.reset()
    # endnormalize

    r = Robot()
    t = time.clock()

    r.reset_bot()
    r.reset()

    

    o = 0
    while True:
    	cout = []
    	for i in range(len(cpgns)):
    		cout.append(0)

        for (i, n) in enumerate(cpgns):
            n.euler(dt)

        for (i, n) in enumerate(cpgns):
            n.step()
            #if(j % int(dt_downsampled/dt) == 0):
            #a = Allbot()
            cout[i] = n.y

        


        if(o > 10000 and o % 5 == 0):
            cmd = {
                'lff': cout[3]/normalize_factors[3]-0.2,
                'rff': cout[0]/normalize_factors[0]-0.2,
                'lbf': cout[0]/normalize_factors[0]-0.2,
                'rbf': cout[3]/normalize_factors[3]-0.2,
                'lfl': -cout[2]/normalize_factors[2]-0.4,
                'rfl': cout[1]/normalize_factors[1]+0.4,
                'lbl': -cout[1]/normalize_factors[1]+0.4,
                'rbl': cout[2]/normalize_factors[2]-0.4
            }
            print cmd
    
            r.send_command(cmd)
            #a.command_robot(cmd)

            time.sleep(0.1)
        o += 1

    return cout
if __name__ == '__main__':
    i = IndividualFactory(0.2).getIndividual()
    # i.variables = {'5_vf': 0.36220985581036924, '4_t2': 1.6664397182690704, '4_t1': 1.5082925883862155, '5_ve': 0.1935720689190103, '3_t2': 1.6615556622045302, 'w_0_1': 1, 'w_4_0': 0.28102350546824595, '3_t1': 1.5121567740925808, 'w_1_0': 1, 'w_7_3': 0.8040157104053505, '3_uf': 1.6781301750660522, 'w_2_6': -0.8953488463342655, '1_vf': 0.31766487999219206, '4_ue': 2, '4_uf': 1.416585311513773, '1_ve': 0.6620526874328292, 'w_3_2': 0.7494534243422903, 'w_5_1': 0.3303295688770513, '1_b': 2.1986437442877387, '7_ue': 1.7808730445714875, '5_uf': 1.7447571653308198, '6_uf': 1.6781301750660522, '6_ue': 2, '2_uf': 1.6781301750660522, 'w_3_7': 0.47561005174306226, '2_ue': 1.7247515461961445, 'w_3_1': 0.4243217318939386, 'w_6_2': -0.3720567593981282, 'w_1_3': -0.4726018988103968, '0_ve': 0.6620526874328292, '7_uf': 0.9038930826960421, '4_vf': 0.49718568690521747, '0_vf': 0.8541448133642828, '3_w': -0.660598374694029, 'w_1_5': 0.9617819276815704, '7_t2': 2, '2_t1': 1.4584862335591748, '2_t2': 1.667137440564005, '6_t1': 1.5121567740925808, 'w_0_4': 0.701423846074686, '6_t2': 0.010356313129656902, 'w_0_2': -0.39244113850809353, '6_w': -0.9470285446834503, '1_t1': 0.8204545390648488, '1_t2': 0.6905851937605991, '6_vf': 0.8535913268360503, '0_b': 3.0135395547673527, '3_ve': 0.6620526874328292, '3_vf': -0.07269916929348463, '7_b': 2.1986437442877387, '1_w': -0.6609114150091853, '1_uf': 1.6864585488491481, '1_ue': 2, '7_ve': 0.662075765589351, '5_t2': 1.667137440564005, '6_b': 2.198653263216753, '0_w': -0.6609114150091853, '7_w': -0.660598374694029, '4_ve': 1.3310494218729363, 'w_2_3': 0.2830206822054424, '4_w': -2.9550142977253455, '5_b': 2.1986437442877387, '6_ve': 0.07957815663057533, '7_t1': 1.5121567740925808, '2_vf': 0.8563587594772124, '2_ve': 0.6620526874328292, '4_b': 4.939953380487346, '0_ue': 1.785187479742838, '0_uf': 1.8991274891620953, '2_w': -4.287737218219265, '7_vf': 0.8535913268360503, 'w_2_0': 0.7968599221711385, '3_b': 2.198653263216753, '5_w': -0.6609114150091853, '5_ue': 1.4636937305014472, '5_t1': 1.7522142013399251, '3_ue': 1.7808730445714875, '2_b': 2.1986437442877387, '0_t2': 1.667137440564005, '0_t1': 1.5121567740925808}
    # i.variables = [{'ve': 0.5563835558676465, 'vf': 0.6361258023983271, 'w_7_3': 0.6486796053770958, 'w_2_6': 0.2774235942710805, 'w_2_0': 0.7396435028769481, 'w_2_3': 0.3791670856632451, 'w_5_1': 0.6431222810544351, 'w_4_0': 0.9389314997658513, 'w_3_7': 0.5455835966948493, 'w_3_1': 0.514421550867959, 'u0': 14.295191168877551, 'w_3_2': 0.8761190111270799, 'w_1_3': -0.8443376701891662, 'w_1_0': 0.7180945426309513, 'w_1_5': 0.30533992644459185, 'w_0_2': -0.27679616838922383, 'w_0_1': 0.8375195527414598, 'w_0_4': 0.8341451538430882, 'b': 2.318297582251759, 't2': 1.7298977232602364, 't1': 1.4004998318410284, 'w_6_2': -0.8806787040106245, 'w': -0.6562129704039288, 'ue': 1.698430641866107, 'uf': 0.5990416779090009}, {'ve': 1.0611009444022015, 'vf': 1.5004391077820791, 'w_7_3': 0.6960217153171502, 'w_2_6': 0.3623760856432266, 'w_2_0': 0.8037405027132559, 'w_2_3': 0.00949204579077198, 'w_5_1': 0.7301175627354485, 'w_4_0': 0.8331149898052028, 'w_3_7': 0.6780743945763477, 'w_3_1': 0.2811982425745003, 'u0': 18, 'w_3_2': 1, 'w_1_3': -1, 'w_1_0': 0.7055440559576615, 'w_1_5': 0.31888755133561086, 'w_0_2': -0.33945465241674244, 'w_0_1': 0.8532301568402971, 'w_0_4': 1, 'b': 2.3106276714699847, 't2': 1.7160628686220325, 't1': 1.377670329150678, 'w_6_2': -0.9521506064357698, 'w': -0.6500071400110119, 'ue': 1.8267679071692469, 'uf': 0.5444851919954171}, {'ve': 0.05166616733309154, 'vf': -0.228187502985425, 'w_7_3': 0.6013374954370414, 'w_2_6': 0.19247110289893438, 'w_2_0': 0.6755465030406402, 'w_2_3': 0.7488421255357182, 'w_5_1': 0.5561269993734218, 'w_4_0': 1.0447480097264998, 'w_3_7': 0.41309279881335104, 'w_3_1': 0.7476448591614178, 'u0': 10.590382337755102, 'w_3_2': 0.7522380222541598, 'w_1_3': -0.6886753403783323, 'w_1_0': 0.7306450293042412, 'w_1_5': 0.2917923015535728, 'w_0_2': -0.21413768436170522, 'w_0_1': 0.8218089486426227, 'w_0_4': 0.6682903076861765, 'b': 2.325967493033534, 't2': 1.7437325778984403, 't1': 1.4233293345313789, 'w_6_2': -0.8092068015854794, 'w': -0.6624188007968457, 'ue': 1.570093376562967, 'uf': 0.6535981638225846}, {'ve': 0.5563835558676465, 'vf': 0.6361258023983271, 'w_7_3': 0.6486796053770958, 'w_2_6': 0.2774235942710805, 'w_2_0': 0.7396435028769481, 'w_2_3': 0.3791670856632451, 'w_5_1': 0.21490333427586783, 'w_4_0': 0.9389314997658513, 'w_3_7': 0.5455835966948493, 'w_3_1': 0.514421550867959, 'u0': 18, 'w_3_2': 0.8761190111270799, 'w_1_3': -0.8443376701891662, 'w_1_0': 0.7180945426309513, 'w_1_5': 0.30533992644459185, 'w_0_2': -0.27679616838922383, 'w_0_1': 0.8375195527414598, 'w_0_4': 0.8341451538430882, 'b': 2.318297582251759, 't2': 1.7298977232602364, 't1': 1.4004998318410284, 'w_6_2': -1, 'w': -0.6562129704039288, 'ue': 1.698430641866107, 'uf': 0.5990416779090009}, {'ve': -1.5076862498275565, 'vf': 0.3609538900961786, 'w_7_3': 0.6235223876509334, 'w_2_6': -0.0049913280696872175, 'w_2_0': 0.9879540176670745, 'w_2_3': 0.5249374675883728, 'w_5_1': 0.6116770156830909, 'w_4_0': 0.7313782466066086, 'w_3_7': 0.6891464004130193, 'w_3_1': 0.5867114376311064, 'u0': 12.0, 'w_3_2': 1.0, 'w_1_3': -0.4577372417626818, 'w_1_0': 0.6092261144138673, 'w_1_5': 0.3323590211733384, 'w_0_2': -0.34932947449052404, 'w_0_1': 0.5480003168064838, 'w_0_4': 0.7973838537150484, 'b': 2.214806333905705, 't2': 1.6446965601369596, 't1': 1.4100155664705813, 'w_6_2': -0.5754451683129441, 'w': -0.6613226532673515, 'ue': 1.5385776335800954, 'uf': -0.056049981296626084}][0]
    # i.variables = {'5_vf': -0.01367159547453245, '4_t2': 1.6664397182690704, '4_t1': 1.2014073060267547, '5_ve': 2, '3_t2': 0.8431100306280586, 'w_0_1': 0.3829303043568567, 'w_4_0': 0.4167473789647069, '3_t1': 1.7560783870462904, 'w_1_0': 0.6919047306369661, 'w_7_3': 0.814179967893205, '3_uf': 1.4835666262820275, 'w_2_6': 0.3337829170734661, '1_vf': 2, '4_ue': 0.9188736895838432, '4_uf': 1.7144176782618419, '1_ve': 0.8709866387413892, 'w_3_2': 0.6857447727949066, 'w_5_1': 0.16875441622364307, '1_b': 2.5453896836725107, '7_ue': 1.8735223006870552, '5_uf': 1.2024603957617641, '6_uf': 0.6639891121065493, '6_ue': 0.8336079322804983, '2_uf': 1.348445038272153, 'w_3_7': 0.20316803828411506, '2_ue': -0.25363137908413314, 'w_3_1': 0.3749302355923068, 'w_6_2': -0.5651373729687789, 'w_1_3': -0.7780199704464814, '0_ve': -0.46196548216667255, '7_uf': 2, '4_vf': -1.1773864702352994, '0_vf': -0.8227897465469615, '3_w': -3.218105770506193, 'w_1_5': 0.6524967843161229, '7_t2': 1.750786361735103, '2_t1': 1.9254204214172568, '2_t2': 1.222732974616255, '6_t1': 2, 'w_0_4': 0.46074834951354554, '6_t2': 0.07754571753580686, 'w_0_2': -0.39482957470459573, '6_w': -2.3336401493679526, '1_t1': 1.1145048830522215, '1_t2': 1.167263248237362, '6_vf': -0.9856295110259112, '0_b': 2.19853758352673, '3_ve': 0.6802486716442937, '3_vf': 1.3477701421172572, '7_b': 2.198653263216753, '1_w': -1.5948884745448222, '1_uf': 0.3782537570273148, '1_ue': 1.8735002936172378, '7_ve': 0.8435990088746423, '5_t2': 2, '6_b': 2.1985954233717413, '0_w': -0.6617511080869026, '7_w': -0.40099167084246123, '4_ve': 0.08418829592296584, 'w_2_3': -0.011168698648021058, '4_w': -0.29548478333691175, '5_b': 3.205786920910363, '6_ve': 0.9927015333790509, '7_t1': 1.0071137902322533, '2_vf': 1.3462082587183797, '2_ve': 0.5561694837786695, '4_b': 4.939953380487346, '0_ue': 1.785187479742838, '0_uf': 1.2563152685130015, '2_w': -1.5473849657844156, '7_vf': 0.6445167835977723, 'w_2_0': 0.7968599221711385, '3_b': 2.198385664247745, '5_w': -0.6609114150091853, '5_ue': 2, '5_t1': 1.6054783680437479, '3_ue': 2, '2_b': 2.198522438397566, '0_t2': 2, '0_t1': 1.556675264526679}
    i.variables = {'3_t2': 1.863031779026755,'1_u0': 2.4109377253051414,'w_1_0': 0.6079178452316607,'3_uf': 0.20064493269227163,'1_vf': -1.582337386926483,'w_2_1': -0.7028813804241312,'1_ve': 1.062047430042745,'1_b': 14,'2_uf': 0.8665579741527307,'2_ue': 1.1683354610665597,'w_3_2': -0.8538786893941384,'0_ve': 1.2799871867031578,'w_1_2': -0.8317444021790418,'0_vf': 0.5134285216627616,'3_t1': 1.5399184285124825,'3_w': -5.410810447561214,'2_t1': 1.822801966689982,'2_t2': 1.936514677987102,'0_u0': 2.676822418634552,'3_u0': 2.315149953121307,'1_t1': 1.6694025638718335,'1_t2': 1.9673889890924918,'0_b': 13.995466638700588,'3_ve': 1.1722266625198086,'3_vf': 1.6289249851941192,'1_w': -3.3755523701363446,'1_uf': 1.2505574568269953,'1_ue': 0.7688444119475245,'0_w': -3.5054755372065145,'w_2_3': 0.8573671322128479,'w_0_1': -0.9849070552273014,'2_vf': 0.8405701075387462,'2_ve': -1.3738735059041924,'0_ue': 0.8570555859835706,'0_uf': 1.27844467294707,'2_w': -3.3781761710497786,'3_b': 13.988984950920127,'2_u0': 2.5062530257776565,'3_ue': -1.3198297128420362,'2_b': 14,'0_t2': 1.9933190948626038,'0_t1': 1.9478362048667925}

    print run_simulation(i)